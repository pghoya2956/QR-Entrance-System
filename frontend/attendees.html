<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>참가자 관리 - QR 입장 관리 시스템</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="eventSelector"></div>
    <div id="navigation"></div>
    
    <div class="container">
        <h1>참가자 관리</h1>
        
        <!-- 체크인 현황 -->
        <div class="stats-container">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">전체</div>
                    <div class="stat-value" id="totalAttendees">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">체크인</div>
                    <div class="stat-value" id="checkedIn">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">미체크인</div>
                    <div class="stat-value" id="notCheckedIn">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">체크인율</div>
                    <div class="stat-value" id="checkedInPercentage">-</div>
                </div>
            </div>
        </div>
        
        <!-- 파일 관리 -->
        <div class="file-actions">
            <button class="btn btn-success" onclick="showAddAttendeeModal()">+ 참가자 추가</button>
            <button class="btn btn-primary" onclick="api.downloadCSV()">CSV 다운로드</button>
        </div>
        
        <!-- 검색 및 필터 -->
        <div class="search-filter-section">
            <input type="text" 
                   class="search-box" 
                   id="searchBox"
                   placeholder="이름, 회사명, 등록번호로 검색...">
            
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">전체</button>
                <button class="filter-btn" data-filter="checked">체크인 완료</button>
                <button class="filter-btn" data-filter="unchecked">미체크인</button>
            </div>
        </div>
        
        <!-- 참가자 테이블 -->
        <div class="attendees-table">
            <table>
                <thead>
                    <tr>
                        <th>등록번호</th>
                        <th>이름</th>
                        <th>회사명</th>
                        <th>연락처</th>
                        <th>이메일</th>
                        <th>유형</th>
                        <th>체크인 시간</th>
                        <th>체크인</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody id="attendeesTableBody">
                    <!-- 참가자 목록이 여기에 동적으로 추가됨 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- QR 코드 모달 -->
    <div id="qrModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="qrModalTitle">QR 코드</h2>
                <span class="modal-close" onclick="closeQRModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="qrCode" class="qr-code-container"></div>
                <button class="btn btn-primary" onclick="downloadQR()">QR 코드 다운로드</button>
            </div>
        </div>
    </div>

    <!-- 참가자 추가 모달 -->
    <div id="addAttendeeModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>참가자 추가</h2>
                <span class="modal-close" onclick="closeAddAttendeeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- 탭 전환 -->
                <div class="tabs">
                    <button class="tab-button active" onclick="switchTab('individual')">개별 추가</button>
                    <button class="tab-button" onclick="switchTab('bulk')">일괄 추가 (텍스트)</button>
                    <button class="tab-button" onclick="switchTab('csv')">CSV 파일 업로드</button>
                </div>
                
                <!-- 개별 추가 탭 -->
                <div id="individualTab" class="tab-content active">
                    <form id="addAttendeeForm" onsubmit="handleAddAttendee(event)">
                        <div id="dynamicFormFields">
                            <!-- 동적으로 생성되는 필드들 -->
                        </div>
                        <button type="submit" class="btn btn-primary">추가하기</button>
                    </form>
                </div>
                
                <!-- 일괄 추가 탭 -->
                <div id="bulkTab" class="tab-content" style="display: none;">
                    <p class="bulk-instruction">엑셀에서 복사한 데이터를 붙여넣으세요 (첫 줄은 헤더)</p>
                    <div style="background: #f0f0f0; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-size: 0.9em;">
                        <strong>지원되는 헤더명:</strong><br>
                        • 이름/성명 → 고객명<br>
                        • 회사/소속 → 회사명<br>
                        • 전화/전화번호/휴대폰 → 연락처<br>
                        • 이메일주소/email → 이메일<br>
                        • 구분/참가구분/유형 → 초대/현장방문<br>
                        <small style="color: #666;">※ 탭 또는 쉼표로 구분된 데이터 모두 지원</small>
                    </div>
                    <textarea id="bulkAddData" rows="10" 
                              placeholder="고객명	회사명	이메일	연락처	초대/현장방문
홍길동	ABC회사	hong@abc.com	010-1234-5678	초대
김철수	XYZ회사	kim@xyz.com	010-2345-6789	현장방문"
                              onpaste="handleBulkDataPaste(event)"
                              oninput="previewBulkData()"></textarea>
                    <div id="bulkPreview" class="bulk-preview" style="display: none;margin-top: 20px;">
                        <h3>미리보기</h3>
                        <div id="bulkPreviewContent"></div>
                    </div>
                    <button class="btn btn-primary" onclick="handleBulkAdd()">일괄 추가</button>
                    <div id="bulkAddResult" class="bulk-result" style="display: none;"></div>
                </div>
                
                <!-- CSV 파일 업로드 탭 -->
                <div id="csvTab" class="tab-content" style="display: none;">
                    <div class="csv-upload-section">
                        <p class="csv-instruction">CSV 파일을 선택하여 참가자를 추가하세요</p>
                        <div class="csv-format-info">
                            <p><strong>CSV 파일 형식:</strong></p>
                            <pre>등록번호,고객명,회사명,연락처,이메일,초대/현장방문
1001,홍길동,ABC회사,010-1234-5678,hong@abc.com,초대
1002,김철수,XYZ회사,010-2345-6789,kim@xyz.com,초대</pre>
                        </div>
                        <div class="file-input-wrapper">
                            <input type="file" id="csvAddFile" accept=".csv" onchange="handleCSVFileSelect(event)">
                            <label for="csvAddFile" class="file-input-label">CSV 파일 선택</label>
                        </div>
                        <div id="csvPreview" class="csv-preview" style="display: none;">
                            <h4>미리보기</h4>
                            <div id="csvPreviewContent"></div>
                            <button class="btn btn-primary" onclick="confirmCSVUpload()">업로드 진행</button>
                            <button class="btn btn-secondary" onclick="cancelCSVUpload()">취소</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/audio-feedback.js"></script>
    <script src="js/attendees.js"></script>
    <script>
        // 페이지 초기화
        window.addEventListener('DOMContentLoaded', async () => {
            // 이벤트 선택기 추가
            const eventSelectorDiv = document.getElementById('eventSelector');
            if (eventSelectorDiv) {
                eventSelectorDiv.appendChild(createEventSelector());
            }
            
            // 백엔드 초기화
            const backendReady = await initializeBackends();
            if (!backendReady) {
                showToast('백엔드 연결 실패', 'error');
                return;
            }
            
            // 새로고침 버튼 이벤트
            document.getElementById('refreshBackends')?.addEventListener('click', async () => {
                await initializeBackends();
                showToast('백엔드 목록을 새로고침했습니다.', 'info');
            });
            
            // 네비게이션 추가
            document.getElementById('navigation').appendChild(createNavigation('attendees'));
        });
    </script>
</body>
</html>